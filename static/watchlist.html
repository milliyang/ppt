<!DOCTYPE html>
<html>
<head>
    <title>è¡Œæƒ…ç›‘æ§ - Paper Trade</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/static/icon4-dollar.svg">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/nav.js"></script>
    <style>
        .service-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .service-status.ok { background: rgba(63, 185, 80, 0.15); border: 1px solid #3fb950; }
        .service-status.error { background: rgba(248, 81, 73, 0.15); border: 1px solid #f85149; }
        .service-status.unknown { background: #21262d; border: 1px solid #30363d; }
        .service-status .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .service-status.ok .dot { background: #3fb950; }
        .service-status.error .dot { background: #f85149; }
        .service-status.unknown .dot { background: #8b949e; }
        
        .add-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .add-form input {
            flex: 1;
            padding: 10px 12px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 14px;
        }
        .add-form input:focus {
            outline: none;
            border-color: #58a6ff;
        }
        
        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .watchlist-table th {
            text-align: left;
            padding: 10px 12px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            color: #8b949e;
            font-weight: 500;
        }
        .watchlist-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #21262d;
        }
        .watchlist-table tr:hover {
            background: #161b22;
        }
        
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .status-badge.ok { background: rgba(63, 185, 80, 0.2); color: #3fb950; }
        .status-badge.error { background: rgba(248, 81, 73, 0.2); color: #f85149; }
        .status-badge.pending { background: rgba(136, 146, 157, 0.2); color: #8b949e; }
        .status-badge.unknown { background: rgba(136, 146, 157, 0.2); color: #8b949e; }
        
        .btn-icon {
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn-icon:hover {
            background: #21262d;
            color: #f85149;
        }
        
        .actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 16px;
            color: #58a6ff;
            text-decoration: none;
            font-size: 13px;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        
        .latency {
            color: #8b949e;
            font-size: 11px;
        }
        
        .presets {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #21262d;
        }
        .presets-title {
            font-size: 12px;
            color: #8b949e;
            margin-bottom: 8px;
        }
        .preset-btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 6px;
            margin-bottom: 6px;
        }
        .preset-btn:hover {
            background: #30363d;
        }
    </style>
</head>
<body>
    <div class="header"></div>
    
    <!-- æœåŠ¡çŠ¶æ€ -->
    <div class="service-status unknown" id="service-status" style="max-width:1200px;margin:0 auto 20px auto;">
        <div class="dot"></div>
        <div>
            <strong>yfinance æœåŠ¡</strong>
            <span id="service-message">æ£€æµ‹ä¸­...</span>
            <span class="latency" id="service-latency"></span>
        </div>
        <button class="btn btn-sm" onclick="testService()" style="margin-left:auto;">ğŸ”„ æµ‹è¯•</button>
    </div>
    
    <div class="grid">
        <!-- æ·»åŠ è‚¡ç¥¨ -->
        <div class="card">
            <h2>æ·»åŠ å…³æ³¨</h2>
            <div class="add-form">
                <input type="text" id="add-symbol" placeholder="è‚¡ç¥¨ä»£ç  (å¦‚ AAPL, HK.0700)">
                <button class="btn" onclick="addSymbol()">æ·»åŠ </button>
            </div>
            
            <div class="presets">
                <div class="presets-title">å¿«é€Ÿæ·»åŠ :</div>
                <button class="preset-btn" onclick="addPreset('AAPL')">AAPL</button>
                <button class="preset-btn" onclick="addPreset('GOOGL')">GOOGL</button>
                <button class="preset-btn" onclick="addPreset('MSFT')">MSFT</button>
                <button class="preset-btn" onclick="addPreset('TSLA')">TSLA</button>
                <button class="preset-btn" onclick="addPreset('NVDA')">NVDA</button>
                <button class="preset-btn" onclick="addPreset('HK.0700')">è…¾è®¯</button>
                <button class="preset-btn" onclick="addPreset('HK.9988')">é˜¿é‡Œ</button>
                <button class="preset-btn" onclick="addPreset('SH.600519')">èŒ…å°</button>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="card">
            <h2>æ‰¹é‡æ“ä½œ</h2>
            <div class="actions" style="flex-direction: column; gap: 12px;">
                <button class="btn" onclick="refreshAll()" style="width:100%;">ğŸ”„ åˆ·æ–°æ‰€æœ‰è¡Œæƒ…</button>
                <button class="btn" onclick="initDefault()" style="width:100%;background:#21262d;border:1px solid #30363d;">ğŸ“‹ å¯¼å…¥é»˜è®¤å…³æ³¨</button>
                <button class="btn btn-reset" onclick="clearAll()" style="width:100%;">ğŸ—‘ï¸ æ¸…ç©ºåˆ—è¡¨</button>
            </div>
            <div style="margin-top:16px; font-size:12px; color:#8b949e;">
                <p>â€¢ æ”¯æŒ yfinance æ ¼å¼: AAPL, 0700.HK</p>
                <p>â€¢ æ”¯æŒå¯Œé€”æ ¼å¼: US.AAPL, HK.0700</p>
                <p>â€¢ è¡Œæƒ…ç¼“å­˜ 60 ç§’</p>
            </div>
        </div>
        
        <!-- å…³æ³¨åˆ—è¡¨ -->
        <div class="card" style="grid-column: span 2;">
            <h2>å…³æ³¨åˆ—è¡¨ <span id="watchlist-count" style="font-size:12px;color:#8b949e;margin-left:8px;"></span></h2>
            <div id="watchlist-container">
                <div class="empty-state">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
    
    <script>
        // æµ‹è¯•æœåŠ¡
        async function testService() {
            const statusEl = document.getElementById('service-status');
            const msgEl = document.getElementById('service-message');
            const latencyEl = document.getElementById('service-latency');
            const indicatorEl = document.getElementById('service-indicator');
            
            statusEl.className = 'service-status unknown';
            msgEl.textContent = 'æ£€æµ‹ä¸­...';
            latencyEl.textContent = '';
            
            try {
                const res = await fetch('/api/watchlist/test');
                const data = await res.json();
                
                if (data.status === 'ok') {
                    statusEl.className = 'service-status ok';
                    msgEl.textContent = `æ­£å¸¸ (AAPL: $${data.price})`;
                    indicatorEl.textContent = 'â— æ­£å¸¸';
                    indicatorEl.style.color = '#3fb950';
                } else {
                    statusEl.className = 'service-status error';
                    msgEl.textContent = data.message || 'å¼‚å¸¸';
                    indicatorEl.textContent = 'â— å¼‚å¸¸';
                    indicatorEl.style.color = '#f85149';
                }
                latencyEl.textContent = `(${data.latency_ms}ms)`;
            } catch (e) {
                statusEl.className = 'service-status error';
                msgEl.textContent = 'è¿æ¥å¤±è´¥';
                indicatorEl.textContent = 'â— å¼‚å¸¸';
                indicatorEl.style.color = '#f85149';
            }
        }
        
        // åŠ è½½å…³æ³¨åˆ—è¡¨
        async function loadWatchlist() {
            try {
                const res = await fetch('/api/watchlist');
                const data = await res.json();
                const container = document.getElementById('watchlist-container');
                const countEl = document.getElementById('watchlist-count');
                
                if (!data.watchlist || data.watchlist.length === 0) {
                    container.innerHTML = '<div class="empty-state">æš‚æ— å…³æ³¨è‚¡ç¥¨ï¼Œè¯·æ·»åŠ </div>';
                    countEl.textContent = '';
                    return;
                }
                
                countEl.textContent = `(${data.watchlist.length} åª)`;
                
                let html = `
                    <table class="watchlist-table">
                        <thead>
                            <tr>
                                <th>ä»£ç </th>
                                <th>åç§°</th>
                                <th>ä»·æ ¼</th>
                                <th>çŠ¶æ€</th>
                                <th>æ›´æ–°æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                for (const item of data.watchlist) {
                    const statusClass = item.status || 'unknown';
                    const statusText = {
                        'ok': 'æ­£å¸¸',
                        'error': 'å¤±è´¥',
                        'pending': 'å¾…åˆ·æ–°',
                        'unknown': 'æœªçŸ¥'
                    }[statusClass] || statusClass;
                    
                    const price = item.last_price ? `$${item.last_price.toFixed(2)}` : '-';
                    const updateTime = item.last_update ? new Date(item.last_update).toLocaleString() : '-';
                    const errorTip = item.error ? ` title="${item.error}"` : '';
                    
                    html += `
                        <tr>
                            <td><strong>${item.symbol}</strong></td>
                            <td>${item.name || '-'}</td>
                            <td>${price}</td>
                            <td><span class="status-badge ${statusClass}"${errorTip}>${statusText}</span></td>
                            <td style="color:#8b949e;font-size:12px;">${updateTime}</td>
                            <td>
                                <button class="btn-icon" onclick="refreshOne('${item.symbol}')" title="åˆ·æ–°">ğŸ”„</button>
                                <button class="btn-icon" onclick="removeSymbol('${item.symbol}')" title="åˆ é™¤">âœ•</button>
                            </td>
                        </tr>
                    `;
                }
                
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (e) {
                document.getElementById('watchlist-container').innerHTML = 
                    `<div class="empty-state" style="color:#f85149;">åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }
        
        // æ·»åŠ è‚¡ç¥¨
        async function addSymbol() {
            const input = document.getElementById('add-symbol');
            const symbol = input.value.trim();
            if (!symbol) return;
            
            try {
                const res = await fetch('/api/watchlist', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({symbol})
                });
                const data = await res.json();
                
                if (data.error) {
                    alert(data.error);
                } else {
                    input.value = '';
                    loadWatchlist();
                }
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥: ' + e.message);
            }
        }
        
        // å¿«é€Ÿæ·»åŠ 
        async function addPreset(symbol) {
            try {
                const res = await fetch('/api/watchlist', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({symbol})
                });
                const data = await res.json();
                if (!data.error) {
                    loadWatchlist();
                }
            } catch (e) {}
        }
        
        // åˆ é™¤è‚¡ç¥¨
        async function removeSymbol(symbol) {
            if (!confirm(`ç¡®å®šåˆ é™¤ ${symbol}ï¼Ÿ`)) return;
            
            try {
                await fetch(`/api/watchlist/${encodeURIComponent(symbol)}`, {method: 'DELETE'});
                loadWatchlist();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }
        
        // åˆ·æ–°å•ä¸ª
        async function refreshOne(symbol) {
            try {
                const res = await fetch(`/api/quote/${encodeURIComponent(symbol)}`);
                const quote = await res.json();
                
                // æ›´æ–°æ•°æ®åº“
                await fetch('/api/watchlist/refresh', {method: 'POST'});
                loadWatchlist();
            } catch (e) {
                alert('åˆ·æ–°å¤±è´¥: ' + e.message);
            }
        }
        
        // åˆ·æ–°æ‰€æœ‰
        async function refreshAll() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'åˆ·æ–°ä¸­...';
            
            try {
                const res = await fetch('/api/watchlist/refresh', {method: 'POST'});
                const data = await res.json();
                
                btn.textContent = `âœ“ ${data.ok} æˆåŠŸ, ${data.fail} å¤±è´¥`;
                setTimeout(() => {
                    btn.textContent = 'ğŸ”„ åˆ·æ–°æ‰€æœ‰è¡Œæƒ…';
                }, 2000);
                
                loadWatchlist();
            } catch (e) {
                btn.textContent = 'åˆ·æ–°å¤±è´¥';
                setTimeout(() => {
                    btn.textContent = 'ğŸ”„ åˆ·æ–°æ‰€æœ‰è¡Œæƒ…';
                }, 2000);
            } finally {
                btn.disabled = false;
            }
        }
        
        // æ¸…ç©ºåˆ—è¡¨
        async function clearAll() {
            if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å…³æ³¨ï¼Ÿ')) return;
            
            try {
                await fetch('/api/watchlist/clear', {method: 'POST'});
                loadWatchlist();
            } catch (e) {
                alert('æ¸…ç©ºå¤±è´¥: ' + e.message);
            }
        }
        
        // å¯¼å…¥é»˜è®¤å…³æ³¨
        async function initDefault() {
            try {
                const res = await fetch('/api/watchlist/init', {method: 'POST'});
                const data = await res.json();
                alert(data.message);
                loadWatchlist();
            } catch (e) {
                alert('å¯¼å…¥å¤±è´¥: ' + e.message);
            }
        }
        
        // Enter é”®æ·»åŠ 
        document.getElementById('add-symbol').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addSymbol();
        });
        
        // åˆå§‹åŒ–
        testService();
        loadWatchlist();
    </script>
    <script src="/static/js/app.js"></script>
    <script>
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å¯¼èˆª
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initNav === 'function') {
                initNav({ title: 'è¡Œæƒ…ç›‘æ§', currentRoute: 'watchlist' });
            }
        });
    </script>
</body>
</html>
