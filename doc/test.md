# Paper Trade 测试计划

> 更新时间: 2026-01-22 (v2)

## 问题

- 净值曲线按日记录，需要多天数据才能验证夏普/回撤
- 交易统计需要完整买卖配对才能计算胜率/盈亏比
- 不能等实际时间流逝来测试

## 方案: 测试数据 API

提供 API 一键生成模拟历史数据，快速验证统计功能。

### API 端点

```bash
# 生成测试数据 (默认 30 天)
POST /api/test/generate

# 指定天数
POST /api/test/generate?days=60

# 清理测试数据 (重置账户)
POST /api/test/clean
```

### 生成规则

**股票池：**
| 代码 | 名称 | 特点 |
|------|------|------|
| AAPL | Apple | 稳定蓝筹 |
| TSLA | Tesla | 高波动 |
| GOOGL | Google | 科技龙头 |
| NVDA | NVIDIA | AI 热门 |
| SPY | S&P 500 ETF | 指数 |
| QQQ | Nasdaq 100 ETF | 科技指数 |

**交易模式：**
- 每天 0-3 笔交易（随机）
- 买卖方向随机
- 价格在合理范围波动
- 部分持仓会平仓（产生胜率数据）

**净值模式：**
- 模拟每日净值变化
- 包含上涨、下跌、震荡
- 产生回撤数据

### 验证项目

| 功能 | 验证点 |
|------|--------|
| 收益曲线 | 图表显示多天数据 |
| 夏普比率 | 计算结果合理 |
| 最大回撤 | 正确识别峰谷 |
| 胜率 | 盈亏交易统计正确 |
| 盈亏比 | 平均盈亏计算正确 |
| 持仓分析 | 集中度/HHI 计算 |

### 使用流程

**方式1: Web 界面 (推荐)**

访问 http://localhost:11182/test

- 输入天数，点击「生成测试数据」
- 点击快捷链接验证各功能
- 点击「清理数据」重置

**方式2: API 调用**

```bash
# 1. 生成测试数据
curl -X POST http://localhost:11182/api/test/generate?days=30

# 2. 查看界面验证
# - 访问 http://localhost:11182
# - 检查收益曲线
# - 检查绩效指标
# - 检查交易统计

# 3. 清理 (可选)
curl -X POST http://localhost:11182/api/test/clean
```

---

## 注意事项

- 测试 API 仅用于开发验证
- 生产环境可禁用 (设置 `ENABLE_TEST_API=false`)
- 测试数据会覆盖当前账户数据

---

## 已知问题修复

### 收益曲线最后一天归零 (已修复)

**问题**: 测试数据生成后，收益曲线最后一天显示 0%

**原因**: `reset_account()` 会插入今天的初始记录 (pnl=0)，测试数据从过去 N 天写到昨天，今天的 0 记录没被覆盖

**修复**: 测试数据生成结束后，把最后的净值也写入"今天"

### 绩效统计卡顿 (已优化)

**问题**: 100 天数据时，页面每 30 秒刷新都会卡顿

**原因**: Analytics 每次计算都获取实时行情 + 遍历所有交易做 FIFO 匹配

**优化**:
- Analytics 默认不获取实时行情（用成本价）
- 30 秒自动刷新不再包含 Analytics
- Analytics 仅在页面首次加载和手动刷新时计算
